name: AWS Tagging (Credenciales Temporales)

# Versi√≥n SEGURA: Ingresas credenciales temporales en cada ejecuci√≥n
# Ideal para usar con SSO/credenciales temporales de 1 hora

on:
  workflow_dispatch:
    inputs:
      aws_access_key_id:
        description: 'AWS Access Key ID (temporal)'
        required: true
        type: string
      aws_secret_access_key:
        description: 'AWS Secret Access Key (temporal)'
        required: true
        type: string
      aws_session_token:
        description: 'AWS Session Token (temporal)'
        required: true
        type: string
      resource_arns:
        description: 'ARNs de recursos (separados por coma)'
        required: true
        type: string
      custom_tags:
        description: 'Tags a aplicar (clave1=valor1,clave2=valor2)'
        required: true
        type: string

env:
  AWS_REGION: us-east-1

jobs:
  apply-tags:
    name: Aplicar Tags con Credenciales Temporales
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar boto3
        run: pip install boto3

      - name: Verificar Credenciales Temporales
        env:
          AWS_ACCESS_KEY_ID: ${{ inputs.aws_access_key_id }}
          AWS_SECRET_ACCESS_KEY: ${{ inputs.aws_secret_access_key }}
          AWS_SESSION_TOKEN: ${{ inputs.aws_session_token }}
        run: |
          echo "‚úÖ Verificando credenciales temporales..."
          aws sts get-caller-identity
          
          # Mostrar tiempo de expiraci√≥n (si est√° disponible)
          echo "üïê Credenciales temporales configuradas"

      - name: Aplicar Tags
        env:
          AWS_ACCESS_KEY_ID: ${{ inputs.aws_access_key_id }}
          AWS_SECRET_ACCESS_KEY: ${{ inputs.aws_secret_access_key }}
          AWS_SESSION_TOKEN: ${{ inputs.aws_session_token }}
        run: |
          echo "üöÄ Aplicando tags a recursos..."
          python apply_tags.py \
            --resource-arns "${{ inputs.resource_arns }}" \
            --tags "${{ inputs.custom_tags }}"

      - name: Resumen
        if: success()
        run: |
          echo "‚úÖ Tags aplicados exitosamente"
          echo "üìã ARNs procesados: ${{ inputs.resource_arns }}"
          echo "üè∑Ô∏è  Tags aplicados: ${{ inputs.custom_tags }}"
          echo "üîí Credenciales temporales usadas de forma segura"
